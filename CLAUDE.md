# Neo Together - Development Guide

> **IMPORTANT**: Keep this file up to date when making significant changes to models, endpoints, or features.

## Working with the Project Lead

The project lead is **non-technical**. When communicating:
- Avoid technical jargon and implementation details
- Focus on what things do, not how they work
- Give simple summaries, not code explanations
- Ask clear yes/no or multiple-choice questions when input is needed
- **ALWAYS test and debug before presenting** - Everything must be in working condition before asking the lead to look at it

## Development Rules

1. **NEVER install dependencies directly in Dropbox** - No `npm install`, `pip install`, or creating `node_modules`/`venv` folders in this directory.
2. **Local dev folder**: `~/neo_together/` is used for running the app. It gets **wiped on reboot** and is fully regenerated from Dropbox by the start script.
3. **Use Podman, not Docker** - All container commands use `podman` and `podman compose` (not `docker`/`docker-compose`).
4. Prefer containers for dependency management to keep the repo clean and avoid Dropbox sync issues.

### What persists vs. what gets wiped
- **Dropbox folder**: Source of truth - never wiped
- **~/neo_together/**: Wiped on reboot - regenerated by `./scripts/start.sh`
- **Database**: Stored in podman volumes (~/.local/share/containers/) - persists unless manually cleared
- **Container images**: Cached by podman - persist unless manually cleared

## Recent Session Changes (Jan 2026)

### Android App Setup
- Added Capacitor for building Android APKs
- Created `frontend/Dockerfile.android` for Android builds
- Run `./scripts/build-android.sh` to build APK

### UI Improvements Made
- **Add spot flow**: Fully clickable - "Today/Tomorrow/Weekly" buttons, time presets (Morning/Lunch/Afternoon/Evening) with +/- adjusters
- **Interests**: Click to remove, "+ Add" button to add new ones (no edit button)
- **Preferences**: Gender toggles directly, age/group size have +/- buttons (no edit button)
- **Map clicks**: Now captures actual place names (e.g., "French Louie") not just addresses when clicking on businesses

### Bug Fixes
- Frontend-to-backend proxy connection inside containers
- Database PostGIS extension setup
- Missing `email-validator` dependency

### Test Accounts
After running `./scripts/start.sh`, use these to log in:
- **Alex**: `4e7458660b3a43b814f947a7116acee2`
- **Jordan**: `5335480b68692fbd705e8dd008f1930a`

---

## Project Overview
A Progressive Web App for facilitating real-world meetups based on shared interests and location/time availability. No in-app messaging - purely about connecting people in person.

## Tech Stack

### Backend
- **Framework**: FastAPI (Python 3.11+)
- **Database**: PostgreSQL with PostGIS (geospatial)
- **ORM**: SQLAlchemy 2.0 (async)
- **Auth**: JWT tokens + Magic link email OR private keys
- **Migrations**: Alembic

### Frontend
- **Framework**: React 18 + TypeScript
- **Build**: Vite
- **Styling**: Tailwind CSS
- **State**: Zustand (client) + React Query (server)
- **Maps**: Google Maps + Places API

---

## Project Structure

```
neo_together/
├── backend/
│   ├── app/
│   │   ├── main.py              # FastAPI entry point
│   │   ├── config.py            # Settings from .env
│   │   ├── database.py          # Async SQLAlchemy setup
│   │   ├── dependencies.py      # Auth middleware (get_current_user)
│   │   ├── seed.py              # Seed script for interests + test users
│   │   ├── models/
│   │   │   ├── __init__.py      # Exports all models
│   │   │   ├── user.py          # User, Interest models
│   │   │   ├── availability.py  # Availability model
│   │   │   ├── meetup.py        # MeetupRequest, Meetup models (legacy)
│   │   │   ├── interest_match.py # UserInterest, Match models
│   │   │   └── group.py         # Group, GroupMember, GroupJoinRequest
│   │   ├── schemas/
│   │   │   ├── __init__.py
│   │   │   ├── user.py          # User/Auth schemas
│   │   │   ├── availability.py  # Availability schemas
│   │   │   ├── meetup.py        # Meetup schemas
│   │   │   ├── matching.py      # Discovery/matching schemas
│   │   │   └── group.py         # Group schemas
│   │   ├── routers/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py          # /auth/* - signup, login, magic link
│   │   │   ├── users.py         # /users/* - profile, preferences
│   │   │   ├── interests.py     # /interests - list topics
│   │   │   ├── availability.py  # /availability/* - CRUD
│   │   │   ├── discover.py      # /discover/* - matching
│   │   │   └── groups.py        # /groups/* - group management
│   │   └── utils/
│   │       ├── __init__.py
│   │       ├── security.py      # JWT, bcrypt, key generation
│   │       ├── names.py         # Approved names list
│   │       └── email.py         # Magic link email sending
│   ├── migrations/
│   ├── tests/
│   ├── alembic.ini
│   ├── requirements.txt
│   └── .env.example
├── frontend/
│   ├── src/
│   │   ├── App.tsx              # Router + providers
│   │   ├── main.tsx             # Entry point
│   │   ├── index.css            # Tailwind imports
│   │   ├── pages/
│   │   │   ├── Home.tsx         # Landing page
│   │   │   ├── Login.tsx        # Login (email + private key modes)
│   │   │   ├── Signup.tsx       # Multi-step signup (email + private key)
│   │   │   └── Dashboard.tsx    # Main app hub (map, people, groups, matches)
│   │   ├── components/
│   │   │   ├── Layout.tsx       # Nav + header
│   │   │   ├── LocationPicker.tsx # Google Places autocomplete
│   │   │   ├── AvailabilityForm.tsx # Add/edit availability
│   │   │   ├── TipsModal.tsx    # Tips and hints modal
│   │   │   └── OpenSourceNotice.tsx # Open source explanation
│   │   └── stores/
│   │       └── auth.ts          # Zustand auth store
│   ├── public/
│   ├── package.json
│   ├── vite.config.ts
│   ├── tsconfig.json
│   └── .env.example
├── docker-compose.yml           # PostgreSQL + PostGIS
└── README.md                    # Original vision doc
```

---

## Database Models

### User
- `id` (UUID, PK)
- `private_key_hash` (SHA256 hash)
- `first_name` (from approved list)
- `birth_year`, `gender`
- `is_available` (global toggle)
- `interests` (M2M → Interest)
- **Preferences:**
  - `min_age_preference`, `max_age_preference` (optional)
  - `gender_preferences` (array of strings)
  - `min_group_size`, `max_group_size` (default 2, 10)
- **Email Auth:**
  - `email` (unique, optional for legacy users)
  - `magic_token`, `magic_token_expires`

### Interest (Topics/Hobbies)
- `id`, `name`, `category`
- Seeded with ~50 interests across categories

### Availability
- `id`, `user_id` (FK → User)
- `location_name`, `latitude`, `longitude`, `location` (PostGIS)
- `radius_meters` (optional)
- `time_start`, `time_end` (HH:MM strings)
- `repeat_days` (array of 0-6 for Mon-Sun)
- `is_active`

### UserInterest (Expressing interest in meeting someone)
- `id`, `requester_id`, `target_id`, `availability_id`
- Unique constraint on (requester, target, availability)

### Match (Mutual interest)
- `id`, `user1_id`, `user2_id`, `availability_id`
- `status`: pending → time_proposed → confirmed
- `proposed_datetime`, `proposed_by_id`, `confirmed_at`

### Group (Formed on mutual match)
- `id`, `availability_id`, `status`, `created_at`
- Groups auto-form when two users match

### GroupMember
- `id`, `group_id`, `user_id`, `role`, `status`, `joined_at`
- Roles: founder, member
- Status: confirmed, pending, declined

### GroupJoinRequest
- `id`, `group_id`, `user_id`, `status`, `created_at`, `responded_at`
- For users requesting to join existing groups

---

## API Endpoints

### Auth (`/auth`)
- `POST /signup` - Create account with private key
- `POST /signup-with-email` - Create account with email
- `POST /login` - Login with private key, returns JWT
- `POST /request-magic-link` - Send login link to email
- `POST /verify-magic-link` - Verify token, return JWT
- `GET /approved-names` - List of valid first names

### Users (`/users`)
- `GET /me` - Current user profile
- `PATCH /me/availability` - Toggle global availability
- `PATCH /me/preferences` - Update age/gender/group preferences

### Interests (`/interests`)
- `GET /` - List all interest topics

### Availability (`/availability`)
- `GET /` - My availability slots
- `POST /` - Create slot
- `GET /{id}` - Get slot
- `PATCH /{id}` - Update slot
- `DELETE /{id}` - Delete slot

### Discovery (`/discover`)
- `GET /locations` - Locations with people counts
- `GET /locations/{id}/people` - People at location (sorted by preference match)
- `POST /interest` - Express interest (creates Match + Group if mutual)
- `GET /matches` - My matches
- `POST /matches/{id}/propose-time` - Propose meetup time
- `POST /matches/{id}/confirm` - Confirm proposed time
- `GET /interests/sent` - Interests I've expressed

### Groups (`/groups`)
- `GET /` - My groups
- `GET /join-requests` - Pending join requests for my groups
- `POST /{id}/join` - Request to join a group
- `POST /join-requests/{id}/accept` - Accept join request
- `POST /join-requests/{id}/decline` - Decline join request

---

## Key Features

### Discovery & Matching
- **Location search**: Google Places autocomplete to search/jump to locations
- **People sorting**: Sorted by preference match (age + gender) then time overlap
- **Interest display**: Shows "You both like" (shared) and "They also like" (other)
- **"I'll be here too"**: Add yourself to an existing spot with one click

### Groups
- Auto-formed when two users mutually match
- Others can request to join groups
- Group size preferences (min/max) enforced
- Join request accept/decline by any member

### Authentication
- **Email (recommended)**: Magic link sent to email, click to login
- **Private key (legacy)**: 32-char hex key, user must save it

### User Preferences
- Age range (min/max)
- Gender preferences (multi-select)
- Group size comfort (min/max people)

### UI Features
- Tips modal with location-specific and general advice
- Open source notice explaining transparency
- Available/Away toggle with explanation

---

## Running Locally (Podman)

### Prerequisites
- Podman
- Google Cloud API key (Maps + Places APIs)
- Android Studio (only for emulator testing)

### Development Setup

```bash
# Start all services (database, backend, frontend)
podman compose up -d

# View logs
podman compose logs -f

# Stop all services
podman compose down
```

Services:
- **Frontend**: http://localhost:5173
- **Backend API**: http://localhost:8000
- **API Docs**: http://localhost:8000/docs

### First-time Database Setup

```bash
# After services are running, seed the database
podman exec neo_together_backend python -m app.seed                    # Interests only
podman exec neo_together_backend python -m app.seed --with-test-users  # + test users
```

### Android Build

```bash
# Build debug APK
./scripts/android-build.sh debug

# Build release APK
./scripts/android-build.sh release
```

The APK will be in `frontend/android/app/build/outputs/apk/`

### First Android Build

The first build will initialize the Android project:
```bash
# Inside the android build container, Capacitor creates the android/ folder
./scripts/android-build.sh debug
```

---

## Environment Variables

### Backend (.env)
```
DEBUG=true
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/neo_together
SECRET_KEY=your_secret_key_here  # openssl rand -hex 32
FRONTEND_URL=http://localhost:5173

# Email (optional - magic links printed to console in debug mode)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=noreply@neotogether.app
```

### Frontend (.env)
```
VITE_GOOGLE_MAPS_API_KEY=your_google_maps_api_key
```

---

## Test Users

Run `python -m app.seed --with-test-users` to create:

| Name | Age | Gender | Location | Interests |
|------|-----|--------|----------|-----------|
| Alex | 25 | male | Central Park | Hiking, Coffee, Programming |
| Jordan | 30 | female | Brooklyn Coffee | Photography, Yoga, Travel |
| Sam | 28 | non-binary | Chelsea Piers | Soccer, Video Games, Anime |
| Taylor | 35 | male | East Village | Music, Concerts, Wine |
| Morgan | 23 | female | Bryant Park | AI & ML, Running, Travel |

Private keys are printed to console when seeding.

---

## Key Design Decisions

1. **Dual Auth**: Email magic links (recommended) + private keys (legacy support)
2. **Approved Names**: Limited name list prevents unique names being identifiable
3. **No Messaging**: Forces real-world interaction - the whole point of the app
4. **Manual Matching**: No algorithm - users browse and choose who to meet
5. **Mutual Interest**: Both must express interest before Match is created
6. **Auto Groups**: Groups form automatically on mutual match
7. **Location-First**: Everything revolves around WHERE people want to meet
8. **Open Source**: Full transparency - code is publicly auditable
